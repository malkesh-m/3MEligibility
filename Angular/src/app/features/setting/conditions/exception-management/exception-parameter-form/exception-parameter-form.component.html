<div class="exception-parameter-form-container">
    <!-- Top Bar for List View -->
    <app-top-bar [title]="'Rules' | translate" [searchPlaceholder]="'Search' | translate" [(searchTerm)]="searchTerm"
        (searchChange)="applyFilter($event)">

        <div class="action-group">
            <button class="clickable-icon" appUseractivity="User Click on Add button" [componentName]="'RulesComponent'"
                [actionType]="'ButtonClick'" (click)="insertNewRecord()">
                <mat-icon matTooltip="{{ 'Add' | translate }}">add_circle_outline</mat-icon>
            </button>
            <button class="clickable-icon" appUseractivity="User Click on Download Template button"
                [componentName]="'RulesComponent'" [actionType]="'ButtonClick'" (click)="downloadTemplate()"
                *ngIf="hasPermission('58')">
                <mat-icon matTooltip="{{ 'Download Template' | translate }}">cloud_download</mat-icon>
            </button>
            <button class="clickable-icon" appUseractivity="User Click on Template button"
                [componentName]="'RulesComponent'" [actionType]="'ButtonClick'" (click)="fileInput.click()"
                *ngIf="hasPermission('58')">
                <mat-icon matTooltip="{{ 'Import' | translate }}">upload</mat-icon>
            </button>
            <button class="clickable-icon" (click)="exportRules()" *ngIf="hasPermission('57')">
                <mat-icon matTooltip="{{ 'Export' | translate }}">download</mat-icon>
            </button>
            <button class="clickable-icon" (click)="deleteCheckedMultipleRules()" *ngIf="hasPermission('56')">
                <mat-icon matTooltip="{{ 'Delete' | translate }}">delete_outline</mat-icon>
            </button>
            <input type="file" #fileInput (change)="onFileSelected($event)" style="display: none;" />
        </div>
    </app-top-bar>

    <!-- Form Section (Edit Panel Style) -->
    @if (formVisible) {
    <div class="edit-panel mt-4 mb-4">
        <div class="panel-header">
            <h3>{{ (isInsertNewRecord ? 'New Rule' : 'Edit Rule') | translate }}</h3>
        </div>
        <div class="panel-body">
            <form [formGroup]="expressionForm" (ngSubmit)="submit()">
                <div class="row">
                    <div class="col-md-4">
                        <mat-form-field appearance="outline">
                            <mat-label>{{ 'Rule Name' | translate }}</mat-label>
                            <input matInput formControlName="name" (input)="sanitizeCode($event)" required>
                            @if (expressionForm.get('name')?.invalid && expressionForm.get('name')?.touched) {
                            <mat-error>{{ 'Rule Name is required' | translate }}</mat-error>
                            }
                        </mat-form-field>
                    </div>
                    <div class="col-md-4">
                        <mat-form-field appearance="outline">
                            <mat-label>{{ 'Rule Description' | translate }}</mat-label>
                            <input matInput formControlName="description" (input)="sanitizeCode($event)" required>
                            @if (expressionForm.get('description')?.invalid &&
                            expressionForm.get('description')?.touched) {
                            <mat-error>{{ 'Rule Description is required' | translate }}</mat-error>
                            }
                        </mat-form-field>
                    </div>
                    <div class="col-md-4">
                        <mat-form-field appearance="outline">
                            <mat-label>{{ 'Parent Rule' | translate }}</mat-label>
                            <mat-select formControlName="parentRuleId">
                                <mat-option value="" disabled>{{ 'Select Parent Rule' | translate }}</mat-option>
                                @for (erule of parentRules; track erule.eruleId) {
                                <mat-option [value]="erule.eruleId">{{ erule.eruleName }}</mat-option>
                                }
                            </mat-select>
                            @if (expressionForm.get('parentRuleId')?.touched &&
                            expressionForm.get('parentRuleId')?.invalid) {
                            <mat-error>{{ 'Parent rule is required' | translate }}</mat-error>
                            }
                        </mat-form-field>
                    </div>
                </div>

                <!-- Expression Builder -->
                <div class="expression-builder-form mt-4">
                    <div class="row g-2">
                        <div class="col">
                            <mat-form-field appearance="outline">
                                <mat-label>{{ '(' | translate }}</mat-label>
                                <mat-select [disabled]="isOpenParenthesis"
                                    (selectionChange)="onSelect('openParenthesis', $event)">
                                    <mat-option value="" disabled selected>-</mat-option>
                                    @for (item of openParanthesis; track item) {
                                    <mat-option [value]="item">{{ item }}</mat-option>
                                    }
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="col">
                            <mat-form-field appearance="outline">
                                <mat-label>{{ 'Parameter' | translate }}</mat-label>
                                <mat-select [disabled]="isParameterName"
                                    (selectionChange)="onSelect('parameter', $event)">
                                    <mat-option value="" disabled selected>{{ 'Parameter Name' | translate
                                        }}</mat-option>
                                    @for (param of parameters; track param.parameterName) {
                                    <mat-option [value]="param.parameterName">{{ param.parameterName }}</mat-option>
                                    }
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="col">
                            <mat-form-field appearance="outline">
                                <mat-label>{{ 'Operator' | translate }}</mat-label>
                                <mat-select [disabled]="isOperator" (selectionChange)="onSelect('operator', $event)">
                                    <mat-option value="" disabled selected>{{ 'Operator' | translate }}</mat-option>
                                    @for (operator of operatorsAry; track operator.conditionValue) {
                                    <mat-option [value]="operator.conditionValue">{{ operator.conditionValue
                                        }}</mat-option>
                                    }
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="col">
                            <mat-form-field appearance="outline">
                                <mat-label>{{ 'Factor' | translate }}</mat-label>
                                <mat-select [disabled]="isFactor" (selectionChange)="onSelect('factor', $event)">
                                    <mat-option value="" disabled selected>{{ 'Factor' | translate }}</mat-option>
                                    @for (factor of factors; track factor.value1) {
                                    <mat-option
                                        [value]="isRangeOperator() ? (factor.value1 + '-' + factor.value2) : factor.value1">
                                        {{ isRangeOperator() ? (factor.value1 + ' - ' + factor.value2) : factor.value1
                                        }}
                                    </mat-option>
                                    }
                                </mat-select>
                                @if (isParameterSelected && factors.length === 0) {
                                <mat-hint>{{ 'No items to show...' | translate }}</mat-hint>
                                }
                            </mat-form-field>
                        </div>
                        <div class="col">
                            <mat-form-field appearance="outline">
                                <mat-label>{{ 'Optional Factor' | translate }}</mat-label>
                                <input matInput type="text" [disabled]="isFactor" formControlName="factorName"
                                    (blur)="onSelect('factor',$event)">
                            </mat-form-field>
                        </div>
                        <div class="col">
                            <mat-form-field appearance="outline">
                                <mat-label>{{ 'AND / OR' | translate }}</mat-label>
                                <mat-select [disabled]="isLogicalOperator"
                                    (selectionChange)="onSelect('logicalOperator', $event)">
                                    <mat-option value="" disabled selected>{{ 'Logical Operator' | translate
                                        }}</mat-option>
                                    @for (logical of logicalOperator; track logical) {
                                    <mat-option [value]="logical">{{ logical }}</mat-option>
                                    }
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="col">
                            <mat-form-field appearance="outline">
                                <mat-label>{{ ')' | translate }}</mat-label>
                                <mat-select [disabled]="isCloseParenthesis"
                                    (selectionChange)="onSelect('closeParenthesis', $event)">
                                    <mat-option value="" disabled selected>{{ 'Close Parenthesis' | translate
                                        }}</mat-option>
                                    @for (item of closeParanthesis; track item) {
                                    <mat-option [value]="item">{{ item }}</mat-option>
                                    }
                                </mat-select>
                            </mat-form-field>
                        </div>
                    </div>

                    <div class="expression-preview">
                        <textarea formControlName="expshown" rows="2" readonly
                            placeholder="{{ 'Build rule expression...' | translate }}"></textarea>
                        @if (expressionForm.get('expshown')?.invalid && expressionForm.get('expshown')?.touched) {
                        <mat-error class="text-xs">
                            {{ 'Rule expression is required' | translate }}
                        </mat-error>
                        }
                        <div class="preview-actions">
                            <button appUseractivity="User Click on Clear button" [componentName]="'RulesComponent'"
                                [actionType]="'ButtonClick'" type="button" class="btn-outline btn-sm"
                                (click)="resetExpression()">
                                <mat-icon>refresh</mat-icon> {{ 'Clear' | translate }}
                            </button>
                            <button appUseractivity="User Click on Remove button" [componentName]="'RulesComponent'"
                                [actionType]="'ButtonClick'" type="button" class="btn-outline btn-sm"
                                (click)="removeLastItem()">
                                <mat-icon>backspace</mat-icon> {{ 'Remove' | translate }}
                            </button>
                            <button appUseractivity="User Click on Validate button" [componentName]="'RulesComponent'"
                                [actionType]="'ButtonClick'" type="button" class="btn-primary btn-sm"
                                (click)="openValidatorDialogAdd(expshown)">
                                <mat-icon>verified</mat-icon> {{ 'Validate' | translate }}
                            </button>
                        </div>
                    </div>
                </div>

                <div class="panel-footer mt-5">
                    <button type="button" class="btn-outline" (click)="cancelEvent()" style="min-width: 120px;">
                        {{ 'Cancel' | translate }}
                    </button>
                    <button [appUseractivity]="isInsertNewRecord ? 'Add button clicked' : 'Update button clicked'"
                        [componentName]="'RulesComponent'" [actionType]="'ButtonClick'" type="submit"
                        class="btn-primary" [disabled]="expressionForm.invalid" style="min-width: 120px;">
                        {{ (isInsertNewRecord ? 'Add Rule' : 'Update Rule') | translate }}
                    </button>
                </div>
            </form>
        </div>
    </div>
    }

    <!-- Table Section -->
    <div class="table-wrapper mat-elevation-z8">
        <table mat-table [dataSource]="dataSource" matSort>
            <!-- Selection Column -->
            <ng-container matColumnDef="select">
                <th mat-header-cell *matHeaderCellDef>
                    <mat-checkbox [checked]="isAllSelected()"
                        (change)="toggleAllSelection($event.checked)"></mat-checkbox>
                </th>
                <td mat-cell *matCellDef="let row">
                    <mat-checkbox [checked]="isRowSelected(row)" (change)="toggleRowSelection(row)"></mat-checkbox>
                </td>
            </ng-container>

            <!-- Name Column -->
            <ng-container matColumnDef="Name">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'Name' | translate }}</th>
                <td mat-cell *matCellDef="let entity" class="fw-medium">{{ entity.Name }}</td>
            </ng-container>

            <!-- Description Column -->
            <ng-container matColumnDef="Description">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'Description' | translate }}</th>
                <td mat-cell *matCellDef="let entity">{{ entity.Description }}</td>
            </ng-container>

            <!-- Expression Column -->
            <ng-container matColumnDef="Expression">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'Exp shown' | translate }}</th>
                <td mat-cell *matCellDef="let entity" class="mono text-xs">{{ entity.Expshown }}</td>
            </ng-container>

            <!-- Created By -->
            <ng-container matColumnDef="createdBy">
                <th mat-header-cell *matHeaderCellDef>
                    <span>{{ 'Created By' | translate }}</span>
                    <mat-icon class="info-icon" (click)="toggleColumn('createdDate','createdBy')"
                        matTooltip="{{ 'Show/Hide Date' | translate }}">
                        @if (rulesColumnsAry.includes('createdDate')) {
                        unfold_less
                        } @else {
                        unfold_more
                        }
                    </mat-icon>
                </th>
                <td mat-cell *matCellDef="let entity">{{ entity.createdBy }}</td>
            </ng-container>

            @if (rulesColumnsAry.includes('createdDate')) {
            <ng-container matColumnDef="createdDate">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'Created Date' | translate }}</th>
                <td mat-cell *matCellDef="let entity" class="mono text-xs">{{ entity.createdByDateTime | date:'short' }}
                </td>
            </ng-container>
            }

            <!-- Updated By -->
            <ng-container matColumnDef="updatedBy">
                <th mat-header-cell *matHeaderCellDef>
                    <span>{{ 'Updated By' | translate }}</span>
                    <mat-icon class="info-icon" (click)="toggleColumn('updatedDate','updatedBy')"
                        matTooltip="{{ 'Show/Hide Date' | translate }}">
                        @if (rulesColumnsAry.includes('updatedDate')) {
                        unfold_less
                        } @else {
                        unfold_more
                        }
                    </mat-icon>
                </th>
                <td mat-cell *matCellDef="let entity">{{ entity.updatedBy }}</td>
            </ng-container>

            @if (rulesColumnsAry.includes('updatedDate')) {
            <ng-container matColumnDef="updatedDate">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'Updated Date' | translate }}</th>
                <td mat-cell *matCellDef="let entity" class="mono text-xs">{{ entity.updatedByDateTime | date:'short' }}
                </td>
            </ng-container>
            }

            <!-- Actions Column -->
            <ng-container matColumnDef="Actions">
                <th mat-header-cell *matHeaderCellDef class="text-left">{{ 'Actions' | translate }}</th>
                <td mat-cell *matCellDef="let entity">
                    <div class="cell-actions">
                        @if (hasPermission('117')) {
                        <mat-icon class="clickable-icon" (click)="copyRecord(entity)"
                            matTooltip="{{ 'Copy' | translate }}">content_copy</mat-icon>
                        }
                        @if (hasPermission('59')) {
                        <mat-icon class="clickable-icon edit" (click)="editRecord(entity)"
                            matTooltip="{{ 'Edit' | translate }}">edit_note</mat-icon>
                        }
                        @if (hasPermission('56')) {
                        <mat-icon class="clickable-icon delete" (click)="deleteRecord(entity)"
                            matTooltip="{{ 'Delete' | translate }}">delete_outline</mat-icon>
                        }
                        @if (hasPermission('118')) {
                        <mat-icon class="clickable-icon validate" (click)="openValidatorDialog(entity)"
                            matTooltip="{{ 'Validate' | translate }}">verified</mat-icon>
                        }
                    </div>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="rulesColumnsAry"></tr>
            <tr mat-row *matRowDef="let row; columns: rulesColumnsAry;"></tr>
        </table>
        <mat-paginator class="paginator" [pageSizeOptions]="[10, 25, 50, 100]" showFirstLastButtons></mat-paginator>
    </div>
</div>

<app-spinner [isLoading]="isLoading || isDownloading || isUploading" [message]="message"></app-spinner>