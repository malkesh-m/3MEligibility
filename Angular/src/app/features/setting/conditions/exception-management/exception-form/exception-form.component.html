<form [formGroup]="exceptionForm" (ngSubmit)="addRecord($event)">
  <!-- Main Form Fields -->
  <div class="row">
    <div class="col-md-4">
      <mat-form-field appearance="outline">
        <mat-label>{{ 'Exception Name' | translate }}</mat-label>
        <input matInput formControlName="exceptionName" (input)="sanitizeCode($event)" required>
        <mat-error *ngIf="exceptionForm.get('exceptionName')?.invalid">{{ 'Exception Name is required' | translate
          }}</mat-error>
      </mat-form-field>
    </div>
    <div class="col-md-4">
      <mat-form-field appearance="outline">
        <mat-label>{{ 'Exception Description' | translate }}</mat-label>
        <input matInput formControlName="description">
      </mat-form-field>
    </div>

    <div class="col-md-4">
      @if (!isScopeSelected) {
      <mat-form-field appearance="outline">
        <mat-label>{{ 'Exception Scope' | translate }}</mat-label>
        <mat-select formControlName="scope" (selectionChange)="onScopeChange()" multiple required>
          <mat-option *ngFor="let scope of exceptionScopes" [value]="scope">{{ scope }}</mat-option>
        </mat-select>
        <mat-error *ngIf="exceptionForm.get('scope')?.invalid">{{ 'Exception Scope is required' | translate
          }}</mat-error>
      </mat-form-field>
      } @else {
      <div class="scope-display d-flex align-items-center gap-3 p-2 border rounded">
        <div class="flex-grow-1">
          <label class="text-xs text-muted d-block">{{ 'Selected Scope' | translate }}</label>
          <span class="fw-medium">{{ exceptionForm.get('scope')?.value?.join(', ') || 'None' }}</span>
        </div>
        <button type="button" class="btn-sm btn-outline" (click)="isScopeSelected = false">
          {{ 'Change' | translate }}
        </button>
      </div>
      <mat-error class="text-xs mt-1" *ngIf="exceptionForm.get('scope')?.hasError('limitWithoutProduct')">
        {{ 'Product Eligibility scope is required when Limit Amount is selected' | translate }}
      </mat-error>
      }
    </div>
  </div>

  <!-- Limit Amount Section -->
  @if (limitAmountEnabled) {
  <div class="limit-section mt-3">
    <div class="row align-items-center">
      <div class="col-md-6">
        <mat-form-field appearance="outline">
          <mat-label>{{ 'Amount Type' | translate }}</mat-label>
          <mat-select formControlName="amountType" (selectionChange)="onChangeAmountType()" required>
            <mat-option value="Fixed">{{ 'Fixed Amount' | translate }}</mat-option>
            <mat-option value="Variation">{{ 'Variation Amount' | translate }}</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <div class="col-md-6">
        <mat-form-field appearance="outline">
          <mat-label>
            {{ 'Percentage' | translate }}
            @if (exceptionForm.get('amountType')?.value === 'Fixed') { (Fixed) }
            @if (exceptionForm.get('amountType')?.value === 'Variation') { (Variation) }
          </mat-label>
          <input matInput type="number" formControlName="percentageValue" (input)="onChangePercentage($event)" min="0"
            max="100" required>
          <mat-error *ngIf="exceptionForm.get('percentageValue')?.invalid">{{ 'Percentage Value is required' | translate
            }}</mat-error>
        </mat-form-field>
      </div>
    </div>
  </div>
  }

  <!-- Temporary Section & Status -->
  <div class="row mt-3 align-items-center">
    <div class="col-md-3">
      <label class="form-check">
        <input type="checkbox" formControlName="isTemporary" (change)="onTemporaryExceptionChange()">
        <span>{{ 'Temporary Exception' | translate }}</span>
      </label>
    </div>

    <div class="col-md-3">
      <mat-form-field appearance="outline">
        <mat-label>{{ 'Start Date' | translate }}</mat-label>
        <input matInput type="date" formControlName="startDate">
        <mat-error *ngIf="exceptionForm.get('isTemporary')?.value && exceptionForm.get('startDate')?.invalid">
          {{ 'Start Date is required' | translate }}
        </mat-error>
      </mat-form-field>
    </div>

    <div class="col-md-3">
      <mat-form-field appearance="outline">
        <mat-label>{{ 'End Date' | translate }}</mat-label>
        <input matInput type="date" formControlName="endDate">
        <mat-error *ngIf="exceptionForm.get('isTemporary')?.value && exceptionForm.get('endDate')?.invalid">
          {{ 'End Date is required' | translate }}
        </mat-error>
      </mat-form-field>
    </div>

    <div class="col-md-3">
      <label class="form-check">
        <input type="checkbox" formControlName="isActive">
        <span>{{ 'IsActive' | translate }}</span>
      </label>
    </div>
  </div>

  @if (productEligibilityEnabled) {
  <div class="row mt-3">
    <div class="col-12">
      <mat-form-field appearance="outline">
        <mat-label>{{ 'Select Stream' | translate }}</mat-label>
        <mat-select formControlName="productId" multiple required>
          <mat-option *ngFor="let product of productsList" [value]="product.productId">
            {{ product.productName }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </div>
  }

  <!-- Expression Builder -->
  <div class="expression-builder-form mt-4">
    <div class="row g-2">
      <div class="col">
        <mat-form-field appearance="outline">
          <mat-label>{{ '(' | translate }}</mat-label>
          <mat-select [disabled]="isOpenParenthesis" (selectionChange)="onSelect('openParenthesis', $event)">
            <mat-option value="">-</mat-option>
            <mat-option *ngFor="let item of openParanthesis" [value]="item">{{ item }}</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <div class="col">
        <mat-form-field appearance="outline">
          <mat-label>{{ 'Parameter Name' | translate }}</mat-label>
          <mat-select [disabled]="isParameterName" (selectionChange)="onSelect('parameter', $event)">
            <mat-option *ngFor="let param of parameters" [value]="param.parameterName">{{ param.parameterName
              }}</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <div class="col">
        <mat-form-field appearance="outline">
          <mat-label>{{ 'Operator' | translate }}</mat-label>
          <mat-select [disabled]="isOperator" (selectionChange)="onSelect('operator', $event)">
            <mat-option *ngFor="let operator of operatorsAry" [value]="operator.conditionValue">{{
              operator.conditionValue }}</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <div class="col">
        <mat-form-field appearance="outline">
          <mat-label>{{ 'Factor' | translate }}</mat-label>
          <mat-select [disabled]="isFactor" (selectionChange)="onSelect('factor', $event)">
            <mat-option *ngFor="let factor of factors"
              [value]="isRangeOperator() ? (factor.value1 + ' - ' + factor.value2) : factor.value1">
              {{ isRangeOperator() ? (factor.value1 + ' - ' + factor.value2) : factor.value1 }}
            </mat-option>
          </mat-select>
          <mat-hint *ngIf="isParameterSelected && factors.length === 0">{{ 'No items to show...' | translate
            }}</mat-hint>
        </mat-form-field>
      </div>
      <div class="col">
        <mat-form-field appearance="outline">
          <mat-label>{{ 'AND / OR' | translate }}</mat-label>
          <mat-select [disabled]="isLogicalOperator" (selectionChange)="onSelect('logicalOperator', $event)">
            <mat-option *ngFor="let logical of logicalOperator" [value]="logical">{{ logical }}</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <div class="col">
        <mat-form-field appearance="outline">
          <mat-label>{{ ')' | translate }}</mat-label>
          <mat-select (selectionChange)="onSelect('closeParenthesis', $event)">
            <mat-option value="">-</mat-option>
            <mat-option *ngFor="let item of closeParanthesis" [value]="item">{{ item }}</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </div>

    <div class="expression-preview">
      <textarea formControlName="expShown" rows="2" readonly
        placeholder="{{ 'Build exception rule...' | translate }}"></textarea>
      <mat-error class="text-xs"
        *ngIf="exceptionForm.get('expShown')?.invalid && exceptionForm.get('expShown')?.touched">
        {{ 'Rule expression is required' | translate }}
      </mat-error>
      <div class="preview-actions">
        <button type="button" class="btn-outline btn-sm" (click)="resetExpression()">
          <mat-icon>refresh</mat-icon> {{ 'Clear' | translate }}
        </button>
        <button type="button" class="btn-outline btn-sm" (click)="removeLastItem()">
          <mat-icon>backspace</mat-icon> {{ 'Remove' | translate }}
        </button>
        <button type="button" class="btn-primary btn-sm" (click)="openValidatorDialogAdd(expShown)">
          <mat-icon>verified</mat-icon> {{ 'Validate' | translate }}
        </button>
      </div>
    </div>
  </div>

  <div class="panel-footer mt-5">
    <button type="button" class="btn-outline" (click)="closeForm()" style="min-width: 120px;">
      {{ 'Cancel' | translate }}
    </button>
    <button type="submit" class="btn-primary" [disabled]="exceptionForm.invalid" style="min-width: 120px;">
      {{ (isEditMode ? 'Update Exception' : 'Add Exception') | translate }}
    </button>
  </div>
</form>