

<div class="mb-3">
  <div>
    <p class="moduleLabel mb-2">{{ 'Eligibility Rules' | translate }}</p>
  </div>
  <div class="d-flex justify-content-between align-items-center">
    <div class="position-relative" style="flex-grow: 1; max-width: 350px;">
      <input type="text" class="form-control me-2" style="width: 300px;" placeholder="{{ 'Search' | translate }}"
        [(ngModel)]="searchTerm" (input)="applyFilter($event)" />
    </div>


    <div class="d-flex align-items-center ms-3">
      <button appUseractivity="User Click on Add button"
              [componentName]="'RulesComponent'"
              [actionType]="'ButtonClick'"  class="btn me-2" (click)="insertNewRecord()" >
        <mat-icon matTooltip="{{ 'Add' | translate }}">add_circle_outline</mat-icon>
      </button>
      <button class="btn" appUseractivity="User Click on Download Tamplate button"
              [componentName]="'RulesComponent'"
              [actionType]="'ButtonClick'" (click)="downloadTemplate()" *ngIf="hasPermission(58)">
        <mat-icon matTooltip="{{ 'Download Template' | translate }}">cloud_download</mat-icon>
      </button>
      <button appUseractivity="User Click on Import button"
              [componentName]="'RulesComponent'"
              [actionType]="'ButtonClick'"  class="btn" (click)="fileInput.click()" *ngIf="hasPermission(58)">
        <mat-icon matTooltip="{{ 'Import' | translate }}">file_upload</mat-icon>
      </button>
      <button appUseractivity="User Click on Export button"
              [componentName]="'RulesComponent'"
              [actionType]="'ButtonClick'"  class="btn" *ngIf="hasPermission(57)">
        <mat-icon matTooltip="{{ 'Export' | translate }}" (click)="exportRules()">file_download</mat-icon>
      </button>
      <input type="file" #fileInput (change)="onFileSelected($event)" style="display: none;" />
      <button appUseractivity="User Click on Delete Multiple button"
              [componentName]="'RulesComponent'"
              [actionType]="'ButtonClick'"  (click)="deleteCheckedMultipleRules()" class="btn" *ngIf="hasPermission(56)">
        <mat-icon matTooltip="{{ 'Delete' | translate }}">delete</mat-icon>
      </button>
    </div>
  </div>
</div>


<div *ngIf="formVisible" class="card p-3 mb-3" #formSection>
  <form [formGroup]="expressionForm" (ngSubmit)="submit()">
    <input type="hidden" formControlName="eruleMasterId" />

    <div class="row align-items-end mb-3">
      <!-- Rule Name -->
      <div class="col-3">
        <label class="inputLabel">{{ 'Rule Name' | translate }} <span class="text-danger">*</span></label>
        <input  (input)="sanitizeCode($event)" [readonly]="IfAddNewVersion" type="text" class="form-control" formControlName="name" maxlength="50"/>
        <div *ngIf="expressionForm.get('name')?.invalid && expressionForm.get('name')?.touched">
          <small class="text-danger">{{ 'Rule Name is required' | translate }}</small>
        </div>
      </div>

      <!-- Rule Description -->
      <div class="col-4">
        <label class="inputLabel">{{ 'Rule Description' | translate }} <span class="text-danger"></span></label>
        <input  (input)="sanitizeCode($event)" type="text" [readonly]="IfAddNewVersion" class="form-control" formControlName="description" />
        <div *ngIf="expressionForm.get('description')?.invalid && expressionForm.get('description')?.touched">
          <small class="text-danger">{{ 'Rule Description is required' | translate }}</small>
        </div>
      </div>
      <div class="col-2 d-flex align-items-center justify-content-start mt-4" *ngIf="!IfAddNewVersion">
        <div class="form-check d-flex align-items-center">
          <input type="checkbox" class="form-check-input me-2 large-checkbox" formControlName="isActive"
            id="isActiveCheck" />
          <label class="form-check-label" for="isActiveCheck" style="font-size: 1rem;">
            {{ 'Is Active' | translate }}
          </label>
        </div>
      </div>


      <!-- Buttons -->
      <div class="col d-flex justify-content-end align-items-end">
        <button appUseractivity="User Click on Add button"
              [componentName]="'RulesComponent'"
              [actionType]="'FormSubmit'"  class="addBtn btn-primary me-2" type="submit"
          *ngIf="!IEditRuleVersion && !IfAddNewVersion && !EditEruleMaster"
          (click)="AddNewEruleMaster(expressionForm.value)">
          {{ 'Add' | translate }}
        </button>

        <button appUseractivity="User Click on Update button"
              [componentName]="'RulesComponent'"
              [actionType]="'FormSubmit'"  class="addBtn btn-primary me-2" type="submit"
          *ngIf="!IEditRuleVersion && !IfAddNewVersion && EditEruleMaster"
          (click)="UpdateEruleMaster(expressionForm.value)">
          {{ 'Update' | translate }}
        </button>
        <button appUseractivity="User Click on Cancel button"
              [componentName]="'RulesComponent'"
              [actionType]="'ButtonClick'"  *ngIf="!IEditRuleVersion && !IfAddNewVersion" class="cancelBtn btn-secondary" type="button" (click)="cancelEvent()">{{ 'Cancel' | translate }}</button>

      </div>
    </div>

    <ng-container *ngIf="IEditRuleVersion || IfAddNewVersion">

      <div class="row mb-3">

        <div class="col-2">
          <label class="inputLabel">{{ 'Valid From' | translate }} <span class="text-danger">*</span></label>
          <input type="date" class="form-control" formControlName="validFrom" />
          <div *ngIf="expressionForm.get('validFrom')?.invalid && expressionForm.get('validFrom')?.touched">
            <small class="text-danger">{{ 'Valid From is required' | translate }}</small>
          </div>
        </div>
        <div class="col-2">
          <label class="inputLabel">{{ 'Valid To' | translate }}</label>
          <input type="date" class="form-control" formControlName="validTo" />

          <!-- Error when Valid To < Valid From -->
          <div *ngIf="expressionForm.errors?.['invalidDateRange'] && expressionForm.get('validTo')?.touched">
            <small class="text-danger">
              {{ 'Please select a Valid To date greater than Valid From date' | translate }}
            </small>
          </div>
        </div>

      </div>
      <!-- Expression Builder -->
      <div class="row mb-3">
        <div class="col">
          <label class="inputLabel">{{ 'Open Parenthesis' | translate }}</label>
          <select #openParenthesisSelect class="form-control" [disabled]="isOpenParenthesis"
            (change)="onSelect('openParenthesis', $event)">
            <option value="" disabled selected>{{ 'Open Parenthesis' | translate }}</option>
            <option *ngFor="let item of openParanthesis" [value]="item">{{ item }}</option>
          </select>
        </div>
        <div class="col">
          <label class="inputLabel">{{ 'Parameter Name' | translate }}</label>
          <select #parameterSelect class="form-control" [disabled]="isParameterName"
            (change)="onSelect('parameter', $event)">
            <option value="" disabled selected>{{ 'Parameter Name' | translate }}</option>
            <option *ngFor="let param of parameters" [value]="param.parameterName">{{ param.parameterName }}</option>
          </select>
        </div>
        <div class="col">
          <label class="inputLabel">{{ 'Operator' | translate }}</label>
          <select #operatorSelect class="form-control" [disabled]="isOperator" (change)="onSelect('operator', $event)">
            <option value="" disabled selected>{{ 'Operator' | translate }}</option>
            <option *ngFor="let operator of operatorsAry" [value]="operator.conditionValue">{{ operator.conditionValue
              }}</option>
          </select>
        </div>
        <div class="col">
          <label class="inputLabel">{{ 'Factor' | translate }}</label>
          <select #factorSelect class="form-control" [disabled]="isFactor" (change)="onSelect('factor', $event)">
            <option value="" disabled selected>{{ 'Factor' | translate }}</option>
            <option *ngFor="let factor of factors"
              [value]="isRangeOperator() ? (factor.value1 + '-' + factor.value2) : factor.value1">
              {{ isRangeOperator() ? (factor.value1 + ' - ' + factor.value2) : factor.value1 }}
            </option>
          </select>
          <div *ngIf="isParameterSelected && factors.length === 0" class="mt-2">{{ 'No items to show...' | translate }}
          </div>
        </div>
        <div class="col">
          <label class="inputLabel">Optional Factor</label>
          <input type="text" class="form-control" [disabled]="isFactor" formControlName="factorName"
            (blur)="onSelect('factor',$event)" />
        </div>
        <div class="col">
          <label class="inputLabel">{{ 'Logical Operator' | translate }}</label>
          <select #logicalOperatorSelect class="form-control" [disabled]="isLogicalOperator"
            (change)="onSelect('logicalOperator', $event)">
            <option value="" disabled selected>{{ 'Logical Operator' | translate }}</option>
            <option *ngFor="let logical of logicalOperator" [value]="logical">{{ logical }}</option>
          </select>
        </div>
        <div class="col">
          <label class="inputLabel">{{ 'Close Parenthesis' | translate }}</label>
          <select #closeParenthesisSelect class="form-control" (change)="onSelect('closeParenthesis', $event)">
            <option value="" disabled selected>{{ 'Close Parenthesis' | translate }}</option>
            <option *ngFor="let item of closeParanthesis" [value]="item">{{ item }}</option>
          </select>
        </div>
      </div>

      <!-- Expression Preview and Buttons -->
      <div class="d-flex flex-wrap align-items-center mt-2">
        <div class="flex-grow-1 me-3">
          <textarea class="form-control w-100" formControlName="expshown" rows="2" readonly></textarea>
          <div *ngIf="expressionForm.get('expshown')?.touched && expressionForm.get('expshown')?.invalid">
            <small class="text-danger">{{ 'Rule expression is required' | translate }}</small>
          </div>
        </div>
        <button appUseractivity="User Click on Cancel button"
              [componentName]="'RulesComponent'"
              [actionType]="'ButtonClick'"  class="cancelBtn btn-outline-secondary me-2" type="button" (click)="resetExpression()">{{ 'Clear' | translate
          }}</button>
        <button appUseractivity="User Click on Remove Last Item button"
              [componentName]="'RulesComponent'"
              [actionType]="'ButtonClick'" class="cancelBtn btn-outline-warning me-2" type="button" (click)="removeLastItem()">{{ 'Remove' | translate
          }}</button>
        <button appUseractivity="User Click on Validate button"
              [componentName]="'RulesComponent'"
              [actionType]="'ButtonClick'" class="addBtn btn-outline-success me-2" type="button" (click)="openValidatorDialogAdd(expshown)">
          {{ 'Validate' | translate }}
        </button>

        <button appUseractivity="User Click on Add button"
                [componentName]="'RulesComponent'"
                [actionType]="'SubmitForm'"
                class="addBtn btn-primary me-2"
                type="submit"
                [disabled]="expressionForm.invalid || expressionForm.errors?.['invalidDateRange']">
          {{ IEditRuleVersion ? ('Update' | translate) : ('Add' | translate) }}
        </button>

        <!--<button *ngIf="IfAddNewVersion" class="addBtn btn-primary me-2" type="submit">{{  ('Add' | translate)  }}</button>-->


        <button appUseractivity="User Click on Cancel button"
              [componentName]="'RulesComponent'"
              [actionType]="'ButtonClick'" class="btn-secondary cancelBtn" type="button" (click)="cancelEvent()">{{ 'Cancel' | translate }}</button>
      </div>
    </ng-container>

  </form>
</div>


<mat-accordion multi>

  <mat-expansion-panel class="rule-panel" *ngFor="let group of paginatedRules">

    <mat-expansion-panel-header class="rule-header">
      <div class="rule-grid">
        <!-- Checkbox -->
        <div class="rule-cell checkbox-cell">
          <mat-checkbox (click)="$event.stopPropagation()"
                        (change)="toggleRuleSelection(group)"
                        [checked]="isRuleSelected(group)">
          </mat-checkbox>
        </div>

        <!-- Rule Name -->
        <div class="rule-cell name-cell" title="{{ group.eruleName }}">
          {{ group.eruleName || 'Unnamed Rule' }}
        </div>

        <!-- Description -->
        <div class="rule-cell desc-cell" title="{{ group.description }}">
          {{ group.description || '-' }}
        </div>

        <!-- Status -->
        <div class="rule-cell status-cell">
          <span class="status-badge" [ngClass]="group.isActive ? 'active' : 'inactive'">
            {{ group.isActive ? 'Active' : 'Inactive' }}
          </span>
        </div>

        <!-- Actions -->
        <div class="rule-cell actions-cell">
          <button mat-icon-button matTooltip="Edit" color="primary"
                  (click)="editRuleMaster(group); $event.stopPropagation()">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button matTooltip="Delete" color="warn"
                  (click)="deleteEruleMaster(group); $event.stopPropagation()">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>
    </mat-expansion-panel-header>



    <div class="text-end mb-2" >
      <!-- <button class="btn btn-outline-primary" (click)="addNewVersion(group)">
        <mat-icon class="me-1">post_add</mat-icon> {{ 'Add New Version' | translate }}
      </button> -->
      <button appUseractivity="User Click on Add New Version button"
              [componentName]="'RulesComponent'"
              [actionType]="'ButtonClick'" mat-raised-button color="primary" (click)="addNewVersion(group)" matTooltip="Add New Version">
        <mat-icon>add</mat-icon> Add New Version
      </button>

    </div>
    <div *ngIf="group.versions?.length > 0; else noVersions">

      <!-- Versions Table -->
      <table class="bgColorWhite mat-elevation-z8" mat-table [dataSource]="group.versions">
        <ng-container matColumnDef="version">
          <th class="cellStyling" mat-header-cell *matHeaderCellDef>{{'Version' | translate }}</th>
          <td class="cellStyling" mat-cell *matCellDef="let item">{{ item.version }}</td>
        </ng-container>

        <ng-container matColumnDef="expression">
          <th class="cellStyling" mat-header-cell *matHeaderCellDef>{{'Expression' | translate}}</th>
          <td class="cellStyling" mat-cell *matCellDef="let item">{{ item.expShown }}</td>
        </ng-container>

        <ng-container matColumnDef="createdByDateTime">
          <th class="cellStyling" mat-header-cell *matHeaderCellDef>{{'Created Date' | translate}}</th>
          <td class="cellStyling" mat-cell *matCellDef="let item">
            {{
 item.createdByDateTime | date:'yyyy-MM-dd hh:mm
            a'
            }}
          </td>
        </ng-container>
        <ng-container matColumnDef="createdBy">
          <th class="cellStyling" mat-header-cell *matHeaderCellDef>{{'Created By'| translate }}</th>
          <td class="cellStyling" mat-cell *matCellDef="let item">{{ item.createdBy}}</td>
        </ng-container>

        <ng-container matColumnDef="updatedByDateTime">
          <th class="cellStyling" mat-header-cell *matHeaderCellDef>{{'Updated Date' | translate}}</th>
          <td class="cellStyling" mat-cell *matCellDef="let item">
            {{
 item.updatedByDateTime | date:'yyyy-MM-dd hh:mm a'
            }}
          </td>
        </ng-container>

        <ng-container matColumnDef="updatedBy">
          <th class="cellStyling" mat-header-cell *matHeaderCellDef>{{'Updated By' | translate}}</th>
          <td class="cellStyling" mat-cell *matCellDef="let item">{{ item.updatedBy }}</td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th class="cellStyling" mat-header-cell *matHeaderCellDef>{{'Actions' | translate}}</th>
          <td class="cellStyling" mat-cell *matCellDef="let item">
            <mat-icon *ngIf="item === group.versions[0]; else disabledEdit"
                      color="primary"
                      class="me-2 clickable-icon"
                      (click)="editRecord(item)"
                      matTooltip="Edit">
              edit
            </mat-icon>

            <ng-template #disabledEdit>
              <mat-icon class="me-2 text-muted"
                        matTooltip="Only Latest version can be edited">
                lock
              </mat-icon>
            </ng-template>
            <mat-icon color="warn" class="clickable-icon" *ngIf="hasPermission(56)" (click)="deleteRecord(item)"
                      matTooltip="Delete">delete</mat-icon>
          </td>
        </ng-container>

        <tr mat-header-row class="tableHeader"
            *matHeaderRowDef="['version', 'expression','createdByDateTime','createdBy','updatedByDateTime', 'updatedBy', 'actions']">
        </tr>
        <tr mat-row class="select-row"
            *matRowDef="let row; columns: ['version', 'expression', 'createdByDateTime','createdBy', 'updatedByDateTime','updatedBy', 'actions']">
        </tr>
      </table>

    </div>

    <ng-template #noVersions>
      <div class="text-center text-muted p-3">
        {{ 'No versions available' | translate }}
      </div>
    </ng-template>
  </mat-expansion-panel>
  <mat-paginator class="paginator"
                 [pageSizeOptions]="[10, 25, 50, 100]"
                 showFirstLastButtons
                 [pageSize]="10">
  </mat-paginator>
</mat-accordion>

