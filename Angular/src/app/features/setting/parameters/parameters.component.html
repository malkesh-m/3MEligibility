<div class="parameters-page">
  <span class="moduleLabel">{{ 'Parameters' | translate }}</span>

  <!-- Search and Actions Top Bar -->
  <div class="filter-bar">
    <div class="search-box">
      <mat-icon>search</mat-icon>
      <input type="text" class="filter-input" [(ngModel)]="searchTerms[activeTab]" (input)="applyFilter()"
        placeholder="{{ 'Search Parameters' | translate }}" />
    </div>

    <div class="action-group d-flex gap-2">
      <button appUseractivity="User Click on Add button" [componentName]="'ParametersComponent'"
        [actionType]="'ButtonClick'" class="clickable-icon" (click)="addParameter()"
        *ngIf="hasPermission('Permissions.Parameter.Create')">
        <mat-icon matTooltip="{{ 'Add Parameter' | translate }}">add_circle_outline</mat-icon>
      </button>

      <button appUseractivity="User Click on Download Template button" [componentName]="'ParametersComponent'"
        [actionType]="'ButtonClick'" class="clickable-icon" (click)="downloadTemplate()">
        <mat-icon matTooltip="{{ 'Download Template' | translate }}">cloud_download</mat-icon>
      </button>

      <button appUseractivity="User Click on Import button" [componentName]="'ParametersComponent'"
        [actionType]="'ButtonClick'" class="clickable-icon" (click)="fileInput.click()"
        *ngIf="hasPermission('Permissions.Parameter.Import')">
        <mat-icon matTooltip="{{ 'Import' | translate }}">upload</mat-icon>
      </button>
      <input type="file" #fileInput (change)="onFileSelected($event)" style="display: none;" />

      <button appUseractivity="User Click on Export button" [componentName]="'ParametersComponent'"
        [actionType]="'ButtonClick'" class="clickable-icon" (click)="exportParameters()"
        *ngIf="hasPermission('Permissions.Parameter.Export')">
        <mat-icon matTooltip="{{ 'Export' | translate }}">download</mat-icon>
      </button>

      <button appUseractivity="User Click on Delete Selected button" [componentName]="'ParametersComponent'"
        [actionType]="'ButtonClick'" (click)="deleteSelectedParameters()" class="clickable-icon"
        *ngIf="hasPermission('Permissions.Parameter.Delete')">
        <mat-icon matTooltip="{{ 'Delete' | translate }}">delete_outline</mat-icon>
      </button>
    </div>
  </div>

  <!-- Add/Edit Form (Edit Panel) -->
  <div *ngIf="formVisible" class="card p-3 mb-3">
    <form [formGroup]="expressionForm" (ngSubmit)="submitEditForm()">
      <div class="row mb-3">
        <div class="col-md-4">
          <label class="inputLabel" for="parameterName">{{ 'Parameter Name' | translate }} <span
              class="text-danger">*</span></label>
          <input id="parameterName" class="form-control" formControlName="parameterName" required maxlength="50"
            (input)="sanitizeCode($event)">
          <div *ngIf="expressionForm.get('parameterName')?.invalid && expressionForm.get('parameterName')?.touched"
            class="text-danger">
            {{ 'Required' | translate }}
          </div>
        </div>
        <div class="col-md-4">
          <label class="inputLabel" for="dataTypeId">{{ 'Parameter Type' | translate }} <span
              class="text-danger">*</span></label>
          <select id="dataTypeId" class="form-control" formControlName="dataTypeId" required>
            <option *ngFor="let type of dataTypes" [value]="type.dataTypeId">
              {{ type.dataTypeName }}
            </option>
          </select>
        </div>
        <div class="col-md-4 d-flex align-items-center mt-4">
          <input type="checkbox" class="form-check-input me-2 mt-0" formControlName="isMandatory" id="isMandatory">
          <label class="form-check-label" for="isMandatory">{{ 'Mandatory' | translate }}</label>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-4">
          <label class="inputLabel" for="rejectionReasonCode">{{ 'Rejection Reason Code' | translate }} <span
              class="text-danger">*</span></label>
          <input id="rejectionReasonCode" class="form-control" formControlName="rejectionReasonCode" required
            maxlength="50" (input)="sanitizeCode($event)">
          <div
            *ngIf="expressionForm.get('rejectionReasonCode')?.invalid && expressionForm.get('rejectionReasonCode')?.touched"
            class="text-danger">
            {{ 'Rejection Reason Code' | translate }}{{ ' is required' | translate }}
          </div>
        </div>
        <div class="col-md-8">
          <label class="inputLabel" for="rejectionReason">{{ 'Rejection Reason Description' | translate }} <span
              class="text-danger">*</span></label>
          <textarea id="rejectionReason" class="form-control" formControlName="rejectionReason" required rows="1"
            maxlength="250" (input)="autoResize($event)"></textarea>
          <div *ngIf="expressionForm.get('rejectionReason')?.invalid && expressionForm.get('rejectionReason')?.touched"
            class="text-danger">
            {{ 'Rejection Reason Description' | translate }}{{ ' is required' | translate }}
          </div>
        </div>
      </div>

      <!-- <div class="row mb-3">
        <div class="col-md-12">
          <button appUseractivity="User Click on Add Computed Value button" [componentName]="'ParametersComponent'"
            [actionType]="'ButtonClick'" type="button" class="btn btn-cyan" (click)="openComputedValuesDialog()">
            <mat-icon>calculate</mat-icon>
            {{ isEditMode ? ('Edit Computed Values' | translate) : ('Add Computed Values' | translate) }}
          </button>
        </div>
      </div> -->

      <div class="d-flex flex-wrap align-items-center justify-content-end">
        <button [appUseractivity]="isInsertNewRecord ? 'Add button clicked' : 'Update button clicked'"
          [componentName]="'ParametersComponent'" [actionType]="'FormSubmit'" type="submit" class="addBtn me-2"
          [disabled]="expressionForm.invalid || showMaxLengthWarning" mat-flat-button>
          {{ isEditMode ? ('Update' | translate) : ('Add' | translate) }}
        </button>
        <button appUseractivity="User Click on Cancel button" [componentName]="'ParametersComponent'"
          [actionType]="'ButtonClick'" type="button" class="cancelBtn" (click)="closeForm()" mat-raised-button>
          {{ 'Cancel' | translate }}
        </button>
      </div>
    </form>
  </div>

  <!-- Redesigned Tabs -->
  <div class="tab-bar tab-nav">
    <div class="tab-item" [class.active]="activeTab === 'product'" (click)="switchTab('product')">
      {{ 'Product' | translate }}
    </div>
  </div>

  <!-- Parameters Table -->
  <div class="table-wrapper">
    <table mat-table [dataSource]="dataSource" matSort class="mat-mdc-table">
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox [checked]="isAllPageSelected()" [indeterminate]="isSomePageSelected()"
            (change)="toggleSelectAll($event)"></mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row">
          <mat-checkbox [checked]="selectedRows.has(row.parameterId)"
            (change)="toggleSelection($event, row.parameterId)"></mat-checkbox>
        </td>
      </ng-container>

      <ng-container matColumnDef="parameterName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'Parameter Name' | translate }}</th>
        <td mat-cell *matCellDef="let parameter" class="simple-text">{{ parameter.parameterName }}</td>
      </ng-container>

      <ng-container matColumnDef="isMandatory">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'Mandatory' | translate }}</th>
        <td mat-cell *matCellDef="let parameter">
          <span class="badge" [ngClass]="parameter.isMandatory ? 'badge-indigo' : 'badge-ghost'">
            {{ (parameter.isMandatory ? 'True' : 'False') | translate }}
          </span>
        </td>
      </ng-container>

      <ng-container matColumnDef="createdBy">
        <th mat-header-cell *matHeaderCellDef>
          {{ 'Created By' | translate }}
          <mat-icon class="info-icon" (click)="toggleColumn('createdDate','createdBy')">
            {{ displayedColumns[activeTab].includes('createdDate') ? 'unfold_less' : 'unfold_more' }}
          </mat-icon>
        </th>
        <td mat-cell *matCellDef="let entity">{{ entity.createdBy }}</td>
      </ng-container>

      <ng-container *ngIf="displayedColumns[activeTab]?.includes('createdDate')" matColumnDef="createdDate">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'Created Date' | translate }}</th>
        <td mat-cell *matCellDef="let entity">{{ entity.createdByDateTime | date:'short' }}</td>
      </ng-container>

      <ng-container matColumnDef="updatedBy">
        <th mat-header-cell *matHeaderCellDef>
          {{ 'Updated By' | translate }}
          <mat-icon class="info-icon" (click)="toggleColumn('updatedDate','updatedBy')">
            {{ displayedColumns[activeTab].includes('updatedDate') ? 'unfold_less' : 'unfold_more' }}
          </mat-icon>
        </th>
        <td mat-cell *matCellDef="let entity">{{ entity.updatedBy }}</td>
      </ng-container>

      <ng-container *ngIf="displayedColumns[activeTab]?.includes('updatedDate')" matColumnDef="updatedDate">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'Updated Date' | translate }}</th>
        <td mat-cell *matCellDef="let entity">{{ entity.updatedByDateTime | date:'short' }}</td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="text-left"> {{ 'Actions' | translate }} </th>
        <td mat-cell *matCellDef="let parameter">
          <div class="cell-actions">
            <mat-icon class="clickable-icon edit" (click)="editParameter(parameter)"
              matTooltip="{{ 'Edit' | translate }}"
              *ngIf="hasPermission('Permissions.Parameter.Edit')">edit_note</mat-icon>
            <mat-icon class="clickable-icon delete" (click)="deleteParameter(parameter)"
              matTooltip="{{ 'Delete' | translate }}"
              *ngIf="hasPermission('Permissions.Parameter.Delete')">delete_outline</mat-icon>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns[activeTab]"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns[activeTab];"></tr>
    </table>
  </div>
  <mat-paginator class="paginator" [pageSizeOptions]="[10, 25, 50, 100]" showFirstLastButtons></mat-paginator>

  <app-spinner [isLoading]="isLoading || isDownloading || isUploading" [message]="message"></app-spinner>
</div>