<div class="mb-3">
    <div>
        <p class="moduleLabel mb-2">{{ activeTab === 'role' ? ('Role' | translate) : ('Assigned Users' | translate) }}
        </p>
    </div>
    <!-- Search and Actions Section -->
    <div class="filter-bar">
        <div class="search-box">
            <mat-icon>search</mat-icon>
            <input type="text" class="filter-input" placeholder="{{ 'Search' | translate }}"
                (input)="applyFilter($event)" [(ngModel)]="searchTerm" style="padding-left: 40px !important;" />
        </div>

        <div class="action-group">
            <button appUseractivity="User Click on Add button" [componentName]="'RoleComponent'"
                [actionType]="'ButtonClick'" class="clickable-icon" (click)="openForm()"
                *ngIf="hasPermission('Permissions.Role.Create')">
                <mat-icon matTooltip="{{ 'Add' | translate }}">add_circle_outline</mat-icon>
            </button>
        </div>
    </div>
</div>

<ul class="nav nav-tabs">
    <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab === 'role'" style="cursor: pointer;" (click)="switchTab('role')">
            {{ 'Role' | translate }}
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab === 'assignedUser'" style="cursor: pointer;"
            (click)="switchTab('assignedUser')">
            {{ 'Assigned Users' | translate }}
        </a>
    </li>
</ul>

<ng-container *ngIf="activeTab?.toLowerCase() == 'role'">
    <!-- Add/Edit Form -->
    <div *ngIf="formVisible" class="card p-3 mb-3">
        <form #form="ngForm" (ngSubmit)="submitEditForm(form)">
            <div class="row mb-3">
                <div class="col">
                    <label class="inputLabel">{{ 'Name' | translate }} <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" [(ngModel)]="formData.roleName" name="Name" required
                        #Name="ngModel" maxlength="50" (input)="sanitizeCode($event)" />
                    <div *ngIf="Name.invalid && Name.touched" class="text-danger">
                        {{ 'Name' | translate }}{{ ' is required' | translate }}
                    </div>
                </div>
                <div class="col">
                    <label class="inputLabel">{{ 'Description' | translate }} <span class="text-danger"></span></label>
                    <input type="text" class="form-control" [(ngModel)]="formData.roleDesc" name="Description"
                        #Description="ngModel" maxlength="250" (input)="sanitizeCode($event)" />
                </div>
                <div class="col" style="align-content: end;">
                    <button appUseractivity="User Click on Add/Edit button" [componentName]="'RoleComponent'"
                        [actionType]="'FormSubmit'" type="submit" class="addBtn btn-primary me-2"
                        [disabled]="form.invalid">
                        {{ isEditMode ? ('Update' | translate) : ('Add' | translate) }}
                    </button>
                    <button appUseractivity="User Click on Cancel button" [componentName]="'RoleComponent'"
                        [actionType]="'ButtonClick'" type="button" class="btn btn-secondary cancelBtn"
                        (click)="closeForm()" style="min-width: 100px; ">
                        {{ 'Cancel' | translate }}
                    </button>
                </div>
            </div>
        </form>
    </div>
    <div class="table-wrapper">
        <table mat-table [dataSource]="dataSource" matSort>

            <ng-container matColumnDef="roleName">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'Name' | translate }}</th>
                <td mat-cell *matCellDef="let list">{{ list.roleName }}</td>
            </ng-container>

            <ng-container matColumnDef="roleDesc">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'Description' | translate
                    }}
                </th>
                <td mat-cell *matCellDef="let list">{{ list.roleDesc }}</td>
            </ng-container>

            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>{{ 'Actions' | translate }}</th>
                <td mat-cell *matCellDef="let list">
                    <mat-icon appUseractivity="User Click on Edit button" [componentName]="'RoleComponent'"
                        [actionType]="'ButtonClick'" class="clickable-icon edit" (click)="editRecord(list)"
                        [matTooltip]="list.roleName === 'Super Admin' ? ('You cannot edit Super Admin role' | translate) : ('Edit' | translate)"
                        *ngIf="hasPermission('Permissions.Role.Edit') && list.roleName !== 'Super Admin'">edit_note</mat-icon>
                    <mat-icon appUseractivity="User Click on Delete button" [componentName]="'RoleComponent'"
                        [actionType]="'ButtonClick'" class="clickable-icon delete" (click)="deleteRecord(list)"
                        [matTooltip]="list.roleName === 'Super Admin' ? ('You cannot delete Super Admin role' | translate) : ('Delete' | translate)"
                        *ngIf="hasPermission('Permissions.Role.Delete') && list.roleName !== 'Super Admin'">delete_outline</mat-icon>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="select-row"></tr>
        </table>
        <mat-paginator class="paginator" [pageSizeOptions]="[10, 25, 50, 100]" showFirstLastButtons></mat-paginator>
    </div>
</ng-container>

<div class="table-wrapper" *ngIf="UnassignedUser && activeTab === 'assignedUser'">
    <div class="card p-3 mb-3">
        <form #form="ngForm" (ngSubmit)="submitEditForm(form)">
            <div class="row mb-3">
                <div class="col-4">
                    <input type="text" class="form-control" placeholder="{{ 'Unassigned users *' | translate }}"
                        [(ngModel)]="searchRole" name="searchRole" (input)="filterRoleNames()" required />
                    <div *ngIf="filteredRoleNames.length > 0" class="mt-2">
                        <div *ngFor="let group of filteredRoleNames; trackBy: trackByUserId">
                            <label *ngIf="group.displayName">
                                <input type="checkbox" [(ngModel)]="group.selected" name="role{{ group.id }}"
                                    (change)="onRoleSelectionChange(group.id)" />
                                {{ group.displayName }}
                            </label>
                        </div>
                    </div>
                </div>
                <div *ngIf="filteredRoleNames.length === 0 && searchRole" class="mt-2">
                    {{ 'No items to show...' | translate }}
                </div>
                <div class="d-flex justify-content-end mt-3">
                    <button [appUseractivity]="!isEditMode ? 'Add button clicked' : 'Update button clicked'"
                        [componentName]="'RoleComponent'" [actionType]="'FormSubmit'" type="submit"
                        class="addBtn btn-primary me-2" style="min-width: 100px">
                        {{ isEditMode ? ('Update' | translate) : ('Add' | translate) }}
                    </button>
                    <button appUseractivity="User Click on Cancel button" [componentName]="'RoleComponent'"
                        [actionType]="'ButtonClick'" style="border: none;" class="cancelBtn" type="button"
                        (click)="closeForm()">
                        {{ 'Cancel' | translate }}
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div *ngIf="activeTab === 'assignedUser'" class="card p-3 mb-3">
    <div class="col-4">
        <label>{{ 'Role Name' | translate }}</label>
        <select #parameterSelect class="form-control" (change)="onSelect($event)">
            <option value="" disabled selected>{{ 'Select' | translate }}</option>
            <option *ngFor="let param of records" [value]="param.roleId">{{
                param.roleName }}</option>
        </select>
    </div>
</div>

<div *ngIf="activeTab === 'assignedUser'" class="table-wrapper">

    <table mat-table [dataSource]="assignedUserDataSource" matSort>

        <ng-container matColumnDef="userName">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> {{ 'Name' | translate }}
            </th>
            <td mat-cell *matCellDef="let entity">
                {{ entity.displayName }}
                <span *ngIf="currentUserId !== null && entity.id === currentUserId" class="self-tag">{{ '(You)' |
                    translate }}</span>
            </td>
        </ng-container>

        <ng-container matColumnDef="mobileNo">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> {{ 'Mobile No' | translate }}
            </th>
            <td mat-cell *matCellDef="let entity"> {{ entity.mobileNo }} </td>
        </ng-container>

        <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> {{ 'Email' | translate }}
            </th>
            <td mat-cell *matCellDef="let entity"> {{ entity.email }} </td>
        </ng-container>

        <ng-container matColumnDef="entityName">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> {{ 'Entity' | translate }}
            </th>
            <td mat-cell *matCellDef="let entity"> {{ entity.entityName }} </td>
        </ng-container>

        <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef> {{ 'Actions' | translate }} </th>
            <td mat-cell *matCellDef="let entity">
                <mat-icon appUseractivity="User Click on Delete button" [componentName]="'RoleComponent'"
                    [actionType]="'ButtonClick'" class="clickable-icon delete"
                    (click)="deleteAssignedUserRecord(entity)" [matTooltip]="getAssignedUserDeleteTooltip()"
                    *ngIf="canDeleteAssignedUser()">delete_outline</mat-icon>
            </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="assignedUserColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: assignedUserColumns;" class="select-row"></tr>
    </table>
    <p style="text-align: center;" *ngIf="assignedUserDataSource.data.length === 0">{{ recordMessage || ('Please select
        role to view assigned user list' | translate) }}</p>
    <mat-paginator class="paginator" [pageSizeOptions]="[10, 25, 50, 100]" showFirstLastButtons></mat-paginator>
</div>
<app-spinner [isLoading]="isLoading || isDownloading || isUploading" [message]="message"></app-spinner>